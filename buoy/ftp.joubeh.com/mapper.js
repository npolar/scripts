var extras = {
  "300234062447630": {
    "deployment date": "2015-01-28T16:00:00Z",
    "deployment lat": 83.0902,
    "deployment lon": 17.7636,
    "name": "CALIB_2015a",
    "old name": "NICE_2015_CALIB1",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234062440630": {
    "deployment date": "2015-01-21T14:00:00Z",
    "deployment lat": 83.1588,
    "deployment lon": 20.0232,
    "name": "CALIB_2015b",
    "old name": "NICE_2015_CALIB2",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234061371430": {
    "deployment date": "2015-04-21T10:00:00Z",
    "deployment lat": 82.966,
    "deployment lon": 16.4936,
    "name": "CALIB_2015c",
    "old name": "NICE_2015_CALIB3",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234061362150": {
    "deployment date": "2015-01-17T16:00:00Z",
    "deployment lat": 83.212,
    "deployment lon": 20.7078,
    "name": "CALIB_2015d",
    "old name": "NICE_2015_CALIB4",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234061369130": {
    "deployment date": "2015-02-10T14:00:00Z",
    "deployment lat": 82.363,
    "deployment lon": 18.9038,
    "name": "CALIB_2015e",
    "old name": "NICE_2015_CALIB5",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234061269230": {
    "deployment date": "2015-01-20T16:00:00Z",
    "deployment lat": 83.1762,
    "deployment lon": 20.0984,
    "name": "CALIB_2015f",
    "old name": "NICE_2015_CALIB6",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234061369140": {
    "deployment date": "2015-04-21T10:00:00Z",
    "deployment lat": 82.9242,
    "deployment lon": 16.1952,
    "name": "CALIB_2015g",
    "old name": "NICE_2015_CALIB7",
    "owner": "Hamburg University",
    "type": "MetOcean CALIB"
  },
  "300234062311650": [
    {
      "deployment date": "2015-01-25T16:00:00Z",
      "deployment lat": 83.0138,
      "deployment lon": 19.8446,
      "name": "SNOW_2015a",
      "old name": "NICE_2015_SNOW1",
      "owner": "Hamburg University",
      "type": "MetOcean snow buoy"
    },
    {
      "deployment date": "2015-04-23T17:00:00Z",
      "deployment lat": 82.7944,
      "deployment lon": 16.2662,
      "name": "SNOW_2015b",
      "old name": "NICE_2015_SNOW1",
      "owner": "Hamburg University",
      "type": "MetOcean snow buoy"
    }
  ],
  "300234062426150": {
    "deployment date": "2015-04-21T13:00:00Z",
    "deployment lat": 83.0042,
    "deployment lon": 16.0852,
    "name": "SNOW_2015c",
    "old name": "NICE_2015_SNOW2",
    "owner": "Hamburg University",
    "type": "MetOcean snow buoy"
  },
  "300234062424060": {
    "deployment date": "2015-03-01T14:00:00Z",
    "deployment lat": 82.948,
    "deployment lon": 26.4312,
    "name": "SNOW_2015d",
    "old name": "S22",
    "owner": "AWI",
    "type": "MetOcean snow buoy"
  },
  "300234062426060": {
    "deployment date": "2015-04-20T15:00:00Z",
    "deployment lat": 83.1798,
    "deployment lon": 16.392,
    "name": "SNOW_2015e",
    "old name": "S23",
    "owner": "AWI",
    "type": "MetOcean snow buoy"
  },
  "300234062447650": {
    "deployment date": "2015-01-18T12:00:00Z",
    "deployment lat": 83.2238,
    "deployment lon": 21.0196,
    "name": "SVP_2015a",
    "old name": "BUOY_1",
    "owner": "NPI",
    "type": "MetOcean i-svp"
  },
  "300234062442640": {
    "deployment date": "2015-04-20T10:00:00Z",
    "deployment lat": 82.8952,
    "deployment lon": 14.0812,
    "name": "SVP_2015b",
    "old name": "BUOY_2",
    "owner": "NPI",
    "type": "MetOcean i-svp"
  },
  "300234011090780": {
    "deployment date": "2015-01-30T19:00:00Z",
    "deployment lat": 83.0382,
    "deployment lon": 16.7684,
    "name": "SVP_2015c",
    "old name": "LANCE1",
    "owner": "FMI",
    "type": "MetOcean i-svp"
  },
  "300234010080470": {
    "deployment date": "2015-04-27T14:00:00Z",
    "deployment lat": 82.2628,
    "deployment lon": 14.4846,
    "name": "SVP_2015d",
    "old name": "LANCE2",
    "owner": "FMI",
    "type": "MetOcean i-svp"
  },
  "300234010084440": {
    "deployment date": "2015-04-20T10:00:00Z",
    "deployment lat": 83.05,
    "deployment lon": 15.0496,
    "name": "SVP_2015e",
    "old name": "LANCE3",
    "owner": "FMI",
    "type": "MetOcean i-svp"
  },
  "300234011091510": {
    "deployment date": "2015-04-20T10:00:00Z",
    "deployment lat": 83.0506,
    "deployment lon": 15.0672,
    "name": "SVP_2015f",
    "old name": "LANCE4",
    "owner": "FMI",
    "type": "MetOcean i-svp"
  },
  "300234062726310": {
    "deployment date": "2015-05-04T16:34:00Z",
    "deployment lat": 82.0064,
    "deployment lon": 11.587,
    "name": "AFAR_2015a",
    "old name": "N-ICE_AFAR1",
    "owner": "NPI",
    "type": "MetOcean radiation buoy"
  },
  "300234062317630": {
    "deployment date": "2015-05-04T12:30:00Z",
    "deployment lat": 82.094,
    "deployment lon": 13.0644,
    "name": "AFAR_2015b",
    "old name": "N-ICE_AFAR2",
    "owner": "NPI",
    "type": "MetOcean radiation buoy"
  },
  "300234062722280": {
    "deployment date": "2015-05-08T12:32:00Z",
    "deployment lat": 81.5986,
    "deployment lon": 10.189,
    "name": "AFAR_2015c",
    "old name": "N-ICE_AFAR3",
    "owner": "NPI",
    "type": "MetOcean radiation buoy"
  }
};

var getExtra = function (doc) {
  var extra;
  if (doc.IMEI) {
    extra = getExtra(doc.IMEI);
  } else if (doc.title) {
    extra = swap(extras)[doc.title];
  }
  var measured = new Date(doc.measured);
  if (extra instanceof Array) {
    var deploys = extra.map(function (obj, i, arr) {
      obj._date = new Date(obj["deployment date"]);
      return obj;
    });
    deploys = deploys.sort(function(a,b){
      return b._date - a._date;
    });

    for (var i in deploys) {
      if (measured >= deploys[i]._date) {
        return deploys[i];
      }
    }
  }
  return extra;
};

var swap = function (json) {
  var ret = {}, key, obj;
  var each = function(extra) {
    extra.IMEI = key;
  };
  for(key in json){
    obj = json[key];
    if (obj instanceof Array) {
      obj.forEach(each);
      ret[obj[0]["old name"]] = obj;
    } else {
      each(obj);
      ret[obj["old name"]] = obj;
    }
  }
  return ret;
};

var functions = {
  "fixDates": function (doc) {
    doc.measured = doc.measured.replace(" ", "T")+"Z";
    return doc;
  },
  "deployment": function (doc) {
    var extra = getExtra(doc);
    if (extra) {
      var measured = new Date(doc.measured);
      if (measured >= new Date(extra["deployment date"])) {
        doc.deployment = {
          date: extra["deployment date"],
          latitude: extra["deployment lat"],
          longitude: extra["deployment lon"]
        };
      }

      if (!("deployment" in doc)) {
        doc = null;
      }
    }
    return doc;
  },
  "extras" : function (doc) {
    if (!Object.keys(doc).length) {
      return null;
    }
    var extra = getExtra(doc);
    if (extra) {
      doc.owner = extra.owner;
      doc.type = extra.type;
      doc.title = extra.name;
      doc.IMEI = doc.IMEI || extra.IMEI;
    }
    return doc;
  }
};
